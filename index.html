<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SACT Prescribing & Verification Incident Reporting Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-input:focus, .form-textarea:focus, .form-radio:focus, .form-checkbox:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            --tw-ring-color: #3b82f6;
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
        }
        .form-section {
            border-top: 1px solid #e5e7eb;
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }
        .spinner {
            border: 2px solid rgba(0, 0, 0, 0.1);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto max-w-4xl p-4 sm:p-6 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">SACT Prescribing & Verification Near-Miss / Incident Reporting Form</h1>
            <p class="mt-2 text-sm sm:text-base font-semibold text-red-700 bg-red-100 p-3 rounded-lg">
                Confidential: This form is for quality improvement purposes to enhance the safety of systemic anticancer therapy (SACT) prescribing.
            </p>
        </header>

        <main class="bg-white p-6 sm:p-8 rounded-xl shadow-lg">
            <form id="incidentForm">
                <!-- Section 1: Administrative Details -->
                <section>
                    <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">1. Administrative Details</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="reportId" class="block text-sm font-medium text-gray-700">Report ID (For internal tracking)</label>
                            <input type="text" id="reportId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input">
                        </div>
                        <div>
                            <label for="reportDate" class="block text-sm font-medium text-gray-700">Date of Report</label>
                            <input type="date" id="reportDate" valueAsDate="new Date()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Reporter's Role</label>
                            <div class="mt-2 space-y-2 sm:space-y-0 sm:flex sm:space-x-6">
                                <div class="flex items-center"><input type="radio" name="reporterRole" value="Prescriber" class="form-radio h-4 w-4 text-blue-600 border-gray-300"><label class="ml-2 text-sm text-gray-700">Prescriber (Doctor/NOCP)</label></div>
                                <div class="flex items-center"><input type="radio" name="reporterRole" value="Pharmacist" class="form-radio h-4 w-4 text-blue-600 border-gray-300"><label class="ml-2 text-sm text-gray-700">Pharmacist</label></div>
                                <div class="flex items-center"><input type="radio" name="reporterRole" value="Nurse" class="form-radio h-4 w-4 text-blue-600 border-gray-300"><label class="ml-2 text-sm text-gray-700">Nurse</label></div>
                                <div class="flex items-center">
                                    <input type="radio" name="reporterRole" value="Other" class="form-radio h-4 w-4 text-blue-600 border-gray-300">
                                    <label class="ml-2 text-sm text-gray-700 mr-2">Other:</label>
                                    <input type="text" id="reporterRoleOther" class="block w-full rounded-md border-gray-300 shadow-sm form-input text-sm p-1">
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Section 2: Incident / Near-Miss Details -->
                <section class="form-section">
                    <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">2. Incident / Near-Miss Details</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="incidentDate" class="block text-sm font-medium text-gray-700">Date of Incident/Discovery</label>
                            <input type="date" id="incidentDate" valueAsDate="new Date()" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input">
                        </div>
                        <div>
                            <label for="incidentTime" class="block text-sm font-medium text-gray-700">Time of Incident/Discovery (24hr format)</label>
                            <input type="time" id="incidentTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Type of Event</label>
                            <div class="mt-2 space-y-2">
                                <div class="flex items-center"><input type="radio" name="eventType" value="Near Miss" class="form-radio h-4 w-4 text-blue-600 border-gray-300"><label class="ml-2 text-sm text-gray-700"><b>Near Miss:</b> An error was detected and corrected before reaching the patient.</label></div>
                                <div class="flex items-center"><input type="radio" name="eventType" value="Incident" class="form-radio h-4 w-4 text-blue-600 border-gray-300"><label class="ml-2 text-sm text-gray-700"><b>Incident:</b> An error reached the patient, regardless of whether harm occurred.</label></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Section 3: Prescribing System Used -->
                <section class="form-section bg-blue-50 p-4 rounded-lg">
                    <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">3. Prescribing System Used <span class="text-red-600 font-semibold">(Critical for Audit)</span></h2>
                    <div class="mt-2 space-y-2">
                        <div class="flex items-center"><input type="radio" name="systemUsed" value="Paper-based" class="form-radio h-4 w-4 text-blue-600 border-gray-300"><label class="ml-2 text-sm text-gray-700 font-medium">Paper-based Prescription</label></div>
                        <div class="flex items-center"><input type="radio" name="systemUsed" value="Electronic (NCIS)" class="form-radio h-4 w-4 text-blue-600 border-gray-300"><label class="ml-2 text-sm text-gray-700 font-medium">Electronic (NCIS)</label></div>
                    </div>
                </section>

                <!-- Section 4: Patient & Treatment Details -->
                <section class="form-section">
                     <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">4. Patient & Treatment Details <span class="text-sm font-normal text-gray-500">(Use patient sticker or anonymised identifiers)</span></h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label for="patientId" class="block text-sm font-medium text-gray-700">Patient Identifier / MRN</label><input type="text" id="patientId" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input"></div>
                        <div><label for="diagnosis" class="block text-sm font-medium text-gray-700">Cancer Diagnosis</label><input type="text" id="diagnosis" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input"></div>
                        <div><label for="protocol" class="block text-sm font-medium text-gray-700">Treatment Protocol/Regimen</label><input type="text" id="protocol" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input"></div>
                        <div><label for="cycleDay" class="block text-sm font-medium text-gray-700">Cycle/Day</label><input type="text" id="cycleDay" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-input"></div>
                    </div>
                </section>

                <!-- Section 5: Error Description -->
                <section class="form-section">
                    <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">5. Error Description</h2>
                     <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="errorSummary" class="block text-sm font-medium text-gray-700">Provide a clear, factual summary of what happened:</label>
                            <button type="button" id="summarizeBtn" class="flex items-center gap-2 text-sm bg-indigo-100 text-indigo-700 font-semibold py-1 px-3 rounded-md hover:bg-indigo-200">
                                ✨ Auto-summarize & Improve
                                <div id="summarizeSpinner" class="spinner hidden"></div>
                            </button>
                        </div>
                        <textarea id="errorSummary" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-textarea"></textarea>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700">At what stage was the error discovered?</label>
                        <div class="mt-2 space-y-2">
                             <div class="flex items-center"><input type="radio" name="discoveryStage" value="During Prescribing" class="form-radio h-4 w-4 text-blue-600 border-gray-300"><label class="ml-2 text-sm text-gray-700">During Prescribing</label></div>
                             <div class="flex items-center"><input type="radio" name="discoveryStage" value="During Pharmacist Verification" class="form-radio h-4 w-4 text-blue-600 border-gray-300"><label class="ml-2 text-sm text-gray-700">During Pharmacist Verification</label></div>
                             <div class="flex items-center"><input type="radio" name="discoveryStage" value="During Nursing Pre-administration Check" class="form-radio h-4 w-4 text-blue-600 border-gray-300"><label class="ml-2 text-sm text-gray-700">During Nursing Pre-administration Check</label></div>
                             <div class="flex items-center"><input type="radio" name="discoveryStage" value="During or After Administration" class="form-radio h-4 w-4 text-blue-600 border-gray-300"><label class="ml-2 text-sm text-gray-700">During or After Administration</label></div>
                             <div class="flex items-center">
                                <input type="radio" name="discoveryStage" value="Other" class="form-radio h-4 w-4 text-blue-600 border-gray-300">
                                <label class="ml-2 text-sm text-gray-700 mr-2">Other:</label>
                                <input type="text" id="discoveryStageOther" class="block w-full rounded-md border-gray-300 shadow-sm form-input text-sm p-1">
                             </div>
                        </div>
                    </div>
                </section>
                
                <!-- Section 6: Error Classification -->
                <section class="form-section">
                    <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">6. Error Classification <span class="text-sm font-normal text-gray-500">(Select all that apply)</span></h2>
                    <div id="errorClassificationCheckboxes" class="space-y-2">
                        <div class="flex items-start"><input name="errorClass" value="Wrong Dose" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5"><label class="ml-2 text-sm text-gray-700"><b>Wrong Dose</b> (e.g., 10mg instead of 100mg)</label></div>
                        <div class="flex items-start"><input name="errorClass" value="Wrong Drug" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5"><label class="ml-2 text-sm text-gray-700"><b>Wrong Drug</b></label></div>
                        <div class="flex items-start"><input name="errorClass" value="Wrong Route" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5"><label class="ml-2 text-sm text-gray-700"><b>Wrong Route</b></label></div>
                        <div class="flex items-start"><input name="errorClass" value="Wrong Frequency or Timing" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5"><label class="ml-2 text-sm text-gray-700"><b>Wrong Frequency or Timing</b></label></div>
                        <div class="flex items-start"><input name="errorClass" value="Calculation Error" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5"><label class="ml-2 text-sm text-gray-700"><b>Calculation Error</b> (e.g., BSA, CrCl)</label></div>
                        <div class="flex items-start"><input name="errorClass" value="Omission of a required drug/fluid" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5"><label class="ml-2 text-sm text-gray-700"><b>Omission of a required drug/fluid</b></label></div>
                        <div class="flex items-start"><input name="errorClass" value="Omission of supportive care" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5"><label class="ml-2 text-sm text-gray-700"><b>Omission of supportive care</b> (e.g., antiemetics, premeds)</label></div>
                        <div class="flex items-start"><input name="errorClass" value="Allergic reaction or contraindication overlooked" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5"><label class="ml-2 text-sm text-gray-700"><b>Allergic reaction or contraindication overlooked</b></label></div>
                        <div class="flex items-start"><input name="errorClass" value="Drug interaction overlooked" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5"><label class="ml-2 text-sm text-gray-700"><b>Drug interaction overlooked</b></label></div>
                        <div class="flex items-start"><input name="errorClass" value="Transcription error" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5"><label class="ml-2 text-sm text-gray-700"><b>Transcription error</b> (from paper to system or vice versa)</label></div>
                        <div class="flex items-center">
                            <input name="errorClass" value="Other" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded">
                            <label class="ml-2 text-sm text-gray-700 mr-2"><b>Other (please specify):</b></label>
                            <input type="text" id="errorClassOther" class="block w-full rounded-md border-gray-300 shadow-sm form-input text-sm p-1">
                         </div>
                    </div>
                </section>

                <!-- Section 7: Incident Outcome -->
                <section class="form-section">
                    <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">7. Incident Outcome <span class="text-sm font-normal text-gray-500">(if applicable)</span></h2>
                     <div>
                        <label for="patientImpact" class="block text-sm font-medium text-gray-700">Describe the impact on the patient:</label>
                        <textarea id="patientImpact" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-textarea"></textarea>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700">Assign a severity level based on the NCC MERP Index:</label>
                        <div class="mt-2 space-y-2">
                             <div class="flex items-start"><input type="radio" name="severity" value="Category B" class="form-radio h-4 w-4 text-blue-600 border-gray-300 mt-0.5"><label class="ml-2 text-sm text-gray-700"><b>Category B:</b> Error occurred but did not reach the patient (i.e., Near Miss)</label></div>
                             <div class="flex items-start"><input type="radio" name="severity" value="Category C" class="form-radio h-4 w-4 text-blue-600 border-gray-300 mt-0.5"><label class="ml-2 text-sm text-gray-700"><b>Category C:</b> Error reached the patient but caused no harm</label></div>
                             <div class="flex items-start"><input type="radio" name="severity" value="Category D" class="form-radio h-4 w-4 text-blue-600 border-gray-300 mt-0.5"><label class="ml-2 text-sm text-gray-700"><b>Category D:</b> Error reached the patient and required monitoring/intervention to preclude harm</label></div>
                             <div class="flex items-start"><input type="radio" name="severity" value="Category E or higher" class="form-radio h-4 w-4 text-blue-600 border-gray-300 mt-0.5"><label class="ml-2 text-sm text-gray-700"><b>Category E or higher:</b> Error contributed to or resulted in patient harm</label></div>
                        </div>
                    </div>
                </section>
                
                <!-- Section 8: Contributing Factors -->
                <section class="form-section">
                    <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">8. Contributing Factors <span class="text-sm font-normal text-gray-500">(Select all that apply)</span></h2>
                    <div id="contributingFactorsCheckboxes" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-2">System Factors</h3>
                            <div class="space-y-2">
                                <div class="flex items-start"><input name="factors" value="NCIS issue" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5"><label class="ml-2 text-sm text-gray-700">NCIS issue (e.g., incorrect default, alert fatigue, system bug)</label></div>
                                <div class="flex items-start"><input name="factors" value="Paper chart issue" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5"><label class="ml-2 text-sm text-gray-700">Paper chart issue (e.g., illegible handwriting, missing information)</label></div>
                                <div class="flex items-start"><input name="factors" value="Lack of integrated information" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5"><label class="ml-2 text-sm text-gray-700">Lack of integrated information</label></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-700 mb-2">Human Factors</h3>
                            <div class="space-y-2">
                                <div class="flex items-start"><input name="factors" value="Distraction or interruption" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5"><label class="ml-2 text-sm text-gray-700">Distraction or interruption</label></div>
                                <div class="flex items-start"><input name="factors" value="High workload / Time pressure" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5"><label class="ml-2 text-sm text-gray-700">High workload / Time pressure</label></div>
                                <div class="flex items-start"><input name="factors" value="Inexperience or lack of knowledge" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5"><label class="ml-2 text-sm text-gray-700">Inexperience or lack of knowledge</label></div>
                                <div class="flex items-start"><input name="factors" value="Lapse in concentration" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5"><label class="ml-2 text-sm text-gray-700">Lapse in concentration</label></div>
                            </div>
                        </div>
                        <div>
                             <h3 class="font-semibold text-gray-700 mb-2">Communication</h3>
                             <div class="space-y-2">
                                <div class="flex items-start"><input name="factors" value="Poor verbal or written communication" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5"><label class="ml-2 text-sm text-gray-700">Poor verbal or written communication</label></div>
                                <div class="flex items-start"><input name="factors" value="Inadequate handover" type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded mt-0.5"><label class="ml-2 text-sm text-gray-700">Inadequate handover</label></div>
                             </div>
                        </div>
                    </div>
                </section>

                <!-- Section 9: Corrective Actions & Recommendations -->
                <section class="form-section">
                    <h2 class="text-xl font-bold text-gray-800 border-b pb-2 mb-4">9. Corrective Actions & Recommendations</h2>
                     <div>
                        <label for="correctiveActions" class="block text-sm font-medium text-gray-700">What immediate actions were taken to correct the error and manage the patient?</label>
                        <textarea id="correctiveActions" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-textarea"></textarea>
                    </div>
                    <div class="mt-4 space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="recommendations" class="block text-sm font-medium text-gray-700">What are your recommendations to prevent this type of error in the future?</label>
                            <button type="button" id="recommendBtn" class="flex items-center gap-2 text-sm bg-indigo-100 text-indigo-700 font-semibold py-1 px-3 rounded-md hover:bg-indigo-200">
                                ✨ Suggest Recommendations
                                <div id="recommendSpinner" class="spinner hidden"></div>
                            </button>
                        </div>
                        <textarea id="recommendations" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm form-textarea"></textarea>
                    </div>
                </section>

                <!-- Submission Button -->
                <div class="mt-8 pt-5">
                    <div class="flex justify-end">
                        <button type="submit" class="w-full sm:w-auto inline-flex justify-center rounded-md border border-transparent bg-blue-600 py-3 px-6 text-base font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                            Submit Report
                        </button>
                    </div>
                </div>
            </form>
        </main>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-sm sm:w-full sm:p-6">
                <div>
                    <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                        <svg class="h-6 w-6 text-green-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-5">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">Report Submitted Successfully</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500">Thank you for your contribution to patient safety.</p>
                        </div>
                    </div>
                </div>
                <div class="mt-5 sm:mt-6">
                    <button type="button" id="closeModal" class="inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('incidentForm');
            const modal = document.getElementById('successModal');
            const closeModalButton = document.getElementById('closeModal');
            const summarizeBtn = document.getElementById('summarizeBtn');
            const recommendBtn = document.getElementById('recommendBtn');
            const errorSummaryTextarea = document.getElementById('errorSummary');
            const recommendationsTextarea = document.getElementById('recommendations');
            const summarizeSpinner = document.getElementById('summarizeSpinner');
            const recommendSpinner = document.getElementById('recommendSpinner');

            // Set default dates
            document.getElementById('reportDate').valueAsDate = new Date();
            document.getElementById('incidentDate').valueAsDate = new Date();
            
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                modal.classList.remove('hidden');
            });

            closeModalButton.addEventListener('click', function() {
                modal.classList.add('hidden');
                form.reset();
                document.getElementById('reportDate').valueAsDate = new Date();
                document.getElementById('incidentDate').valueAsDate = new Date();
            });

            // --- Gemini API Integration ---

            const apiKey = ""; // Canvas will provide this
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            async function callGemini(systemPrompt, userPrompt, spinner) {
                spinner.classList.remove('hidden');
                let retries = 3;
                let delay = 1000;

                while(retries > 0) {
                    try {
                        const payload = {
                            contents: [{ parts: [{ text: userPrompt }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                        };

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`API call failed with status: ${response.status}`);
                        }

                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        spinner.classList.add('hidden');

                        if (text) {
                            return text;
                        } else {
                            throw new Error("No text found in API response.");
                        }

                    } catch (error) {
                        console.error("Gemini API call failed:", error);
                        retries--;
                        if (retries === 0) {
                            spinner.classList.add('hidden');
                            return "Error: Could not generate content. Please try again.";
                        }
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; // Exponential backoff
                    }
                }
            }
            
            summarizeBtn.addEventListener('click', async () => {
                const textToSummarize = errorSummaryTextarea.value;
                if (!textToSummarize.trim()) {
                    alert("Please enter a summary before using the auto-summarize feature.");
                    return;
                }

                const systemPrompt = "You are a clinical safety expert. Your task is to revise an incident report description to be clear, objective, and concise. Remove subjective language, speculation, or blame. Focus only on the sequence of events. Do not add any information that is not present in the original text. Present the output as a neutral, factual summary.";
                
                const improvedText = await callGemini(systemPrompt, textToSummarize, summarizeSpinner);
                errorSummaryTextarea.value = improvedText;
            });

            recommendBtn.addEventListener('click', async () => {
                // Gather context from the form
                const errorDescription = errorSummaryTextarea.value;
                const systemUsed = document.querySelector('input[name="systemUsed"]:checked')?.value || "Not specified";
                
                const selectedErrorClasses = Array.from(document.querySelectorAll('#errorClassificationCheckboxes input[type="checkbox"]:checked'))
                    .map(cb => cb.value).join(', ');

                const selectedFactors = Array.from(document.querySelectorAll('#contributingFactorsCheckboxes input[type="checkbox"]:checked'))
                    .map(cb => cb.value).join(', ');

                if (!errorDescription.trim()) {
                    alert("Please provide an error description before suggesting recommendations.");
                    return;
                }

                const systemPrompt = "You are a patient safety and risk management expert specializing in oncology medication. Based on the following incident details, generate 3-4 specific, actionable recommendations to prevent recurrence. Tailor the recommendations to the system used (Paper-based or Electronic NCIS) and the contributing factors identified. Format the output as a bulleted list using '-' for each point.";
                
                const userPrompt = `
                    Incident Details:
                    - System Used: ${systemUsed}
                    - Error Description: ${errorDescription}
                    - Error Classification(s): ${selectedErrorClasses || "None specified"}
                    - Contributing Factor(s): ${selectedFactors || "None specified"}

                    Please provide recommendations.
                `;

                const recommendations = await callGemini(systemPrompt, userPrompt, recommendSpinner);
                recommendationsTextarea.value = recommendations;
            });
        });
    </script>

</body>
</html>

